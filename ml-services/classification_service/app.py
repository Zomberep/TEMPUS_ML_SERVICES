from transformers import AutoTokenizer, AutoModel
from model import AdvancedMultiLabelMLP
from threading import Thread

import joblib as jb
import numpy as np
import pymorphy3
import string
import torch
import traceback
import json
import time
import pika

DEVICE = torch.device("cuda" if torch.cuda.is_available() else "cpu")

RUBERT_NAME = "./rubert-tiny2"
tokenizer = AutoTokenizer.from_pretrained(RUBERT_NAME)
rubert_model = AutoModel.from_pretrained(RUBERT_NAME).to(DEVICE)
rubert_model.eval()

INPUT_DIM = 312
HIDDEN_DIM = 512
NUM_LABELS = 13

mlp_model = AdvancedMultiLabelMLP(input_dim=INPUT_DIM, num_labels=NUM_LABELS, hidden_dim=HIDDEN_DIM).to(DEVICE)
mlp_model.load_state_dict(torch.load("mlp_model.pth", map_location=DEVICE))
mlp_model.eval()

binary_clf = jb.load("./relations_pipeline.pkl")

thresholds = jb.load("thresholds.pkl") # —Å–ª–æ–≤–∞—Ä—å –∫–∞—Ç–µ–≥–æ—Ä–∏—è -> –ø–æ—Ä–æ–≥
mlb = jb.load("mlb.pkl")               # –æ–±—É—á–µ–Ω–Ω—ã–π MultiLabelBinarizer
RELATIONS_CLASS = "–û—Ç–Ω–æ—à–µ–Ω–∏—è"
if not RELATIONS_CLASS in mlb.classes_:
    raise ValueError("Label '–û—Ç–Ω–æ—à–µ–Ω–∏—è' doesn't exist")

RELATIONS_IDX = np.where(mlb.classes_ == RELATIONS_CLASS)[0][0]

class LabelPredictor:
    morph = pymorphy3.MorphAnalyzer()
    translator = str.maketrans('', '', string.punctuation + string.digits)
    russian_stopwords = ['–∏', '–≤', '–≤–æ', '–Ω–µ', '—á—Ç–æ', '–æ–Ω', '–Ω–∞', '—è', '—Å', '—Å–æ', '–∫–∞–∫', '–∞', '—Ç–æ', '–≤—Å–µ', '–æ–Ω–∞', '—Ç–∞–∫', '–µ–≥–æ', '–Ω–æ', '–¥–∞', '—Ç—ã', '–∫', '—É', '–∂–µ', '–≤—ã', '–∑–∞', '–±—ã', '–ø–æ', '—Ç–æ–ª—å–∫–æ', '–µ–µ', '–º–Ω–µ', '–±—ã–ª–æ', '–≤–æ—Ç', '–æ—Ç', '–º–µ–Ω—è', '–µ—â–µ', '–Ω–µ—Ç', '–æ', '–∏–∑', '–µ–º—É', '—Ç–µ–ø–µ—Ä—å', '–∫–æ–≥–¥–∞', '–¥–∞–∂–µ', '–Ω—É', '–≤–¥—Ä—É–≥', '–ª–∏', '–µ—Å–ª–∏', '—É–∂–µ', '–∏–ª–∏', '–Ω–∏', '–±—ã—Ç—å', '–±—ã–ª', '–Ω–µ–≥–æ', '–¥–æ', '–≤–∞—Å', '–Ω–∏–±—É–¥—å', '–æ–ø—è—Ç—å', '—É–∂', '–≤–∞–º', '–≤–µ–¥—å', '—Ç–∞–º', '–ø–æ—Ç–æ–º', '—Å–µ–±—è', '–Ω–∏—á–µ–≥–æ', '–µ–π', '–º–æ–∂–µ—Ç', '–æ–Ω–∏', '—Ç—É—Ç', '–≥–¥–µ', '–µ—Å—Ç—å', '–Ω–∞–¥–æ', '–Ω–µ–π', '–¥–ª—è', '–º—ã', '—Ç–µ–±—è', '–∏—Ö', '—á–µ–º', '–±—ã–ª–∞', '—Å–∞–º', '—á—Ç–æ–±', '–±–µ–∑', '–±—É–¥—Ç–æ', '—á–µ–≥–æ', '—Ä–∞–∑', '—Ç–æ–∂–µ', '—Å–µ–±–µ', '–ø–æ–¥', '–±—É–¥–µ—Ç', '–∂', '—Ç–æ–≥–¥–∞', '–∫—Ç–æ', '—ç—Ç–æ—Ç', '—Ç–æ–≥–æ', '–ø–æ—Ç–æ–º—É', '—ç—Ç–æ–≥–æ', '–∫–∞–∫–æ–π', '—Å–æ–≤—Å–µ–º', '–Ω–∏–º', '–∑–¥–µ—Å—å', '—ç—Ç–æ–º', '–æ–¥–∏–Ω', '–ø–æ—á—Ç–∏', '–º–æ–π', '—Ç–µ–º', '—á—Ç–æ–±—ã', '–Ω–µ–µ', '—Å–µ–π—á–∞—Å', '–±—ã–ª–∏', '–∫—É–¥–∞', '–∑–∞—á–µ–º', '–≤—Å–µ—Ö', '–Ω–∏–∫–æ–≥–¥–∞', '–º–æ–∂–Ω–æ', '–ø—Ä–∏', '–Ω–∞–∫–æ–Ω–µ—Ü', '–¥–≤–∞', '–æ–±', '–¥—Ä—É–≥–æ–π', '—Ö–æ—Ç—å', '–ø–æ—Å–ª–µ', '–Ω–∞–¥', '–±–æ–ª—å—à–µ', '—Ç–æ—Ç', '—á–µ—Ä–µ–∑', '—ç—Ç–∏', '–Ω–∞—Å', '–ø—Ä–æ', '–≤—Å–µ–≥–æ', '–Ω–∏—Ö', '–∫–∞–∫–∞—è', '–º–Ω–æ–≥–æ', '—Ä–∞–∑–≤–µ', '—Ç—Ä–∏', '—ç—Ç—É', '–º–æ—è', '–≤–ø—Ä–æ—á–µ–º', '—Ö–æ—Ä–æ—à–æ', '—Å–≤–æ—é', '—ç—Ç–æ–π', '–ø–µ—Ä–µ–¥', '–∏–Ω–æ–≥–¥–∞', '–ª—É—á—à–µ', '—á—É—Ç—å', '—Ç–æ–º', '–Ω–µ–ª—å–∑—è', '—Ç–∞–∫–æ–π', '–∏–º', '–±–æ–ª–µ–µ', '–≤—Å–µ–≥–¥–∞', '–∫–æ–Ω–µ—á–Ω–æ', '–≤—Å—é', '–º–µ–∂–¥—É']
    outdoor_words = {"–ø–∞—Ä–∫", "—É–ª–∏—Ü–∞", "–ø–∏–∫–Ω–∏–∫", "–ø–ª—è–∂", "–ø–æ—Ö–æ–¥", "–≤–µ–ª–æ—Å–∏–ø–µ–¥", "–ø—Ä–æ–≥—É–ª–∫–∞", "–Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è", "–≤–µ–ª–æ–ø—Ä–æ–≥—É–ª–∫–∞", "–∑–æ–æ–ø–∞—Ä–∫", "–±–æ—Ç–∞–Ω–∏—á–µ—Å–∫–∏–π", "–∫–∞—Ç–æ–∫", "–±–∞—Å—Å–µ–π–Ω", "—Ä—ã–±–∞–ª–∫–∞", "–∞—ç—Ä–æ–¥–∏–Ω–∞–º–∏–∫–∞", "–∞—ç—Ä–æ–ø–æ—Ä—Ç", "–≥–∞—Ä–∞–∂", "–∞–≤—Ç–æ–º–æ–π–∫–∞", "–∞–≤—Ç–æ—Å–∞–ª–æ–Ω", "–∞–≤—Ç–æ—à–∫–æ–ª–∞", "–≤–æ–∫–∑–∞–ª", "–∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä", "–º—É–∑–µ–π", "–≤—ã—Å—Ç–∞–≤–∫–∞", "–∫–∞—Ñ–µ", "–∫–∏–Ω–æ", "–±–∏–±–ª–∏–æ—Ç–µ–∫–∞", "—Ç–µ–∞—Ç—Ä", "–∫–æ–Ω—Ü–µ—Ä—Ç", "—Ñ–µ—Å—Ç–∏–≤IVAL", "—ç–∫—Å–∫—É—Ä—Å–∏—è", "–≥–∞–ª–µ—Ä–µ—è", "–≥–∞–ª–µ—Ä–µ—è", "–º–∏—Ç–∏–Ω–≥", "–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è", "–ø—Ä–∞–∑–¥–Ω–∏–∫", "–ø—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏–µ", "—è—Ä–º–∞—Ä–∫–∞", "–±–∞–∑–∞—Ä", "—Ä—ã–Ω–æ–∫", "–ø–∞—Ä–∫–æ–≤–∫–∞", "–∞–≤—Ç–æ–±—É—Å", "–ø–æ–µ–∑–¥", "—Å–∞–º–æ–ª—ë—Ç", "—Ç–∞–∫—Å–∏", "–ø–µ—Ä–µ–µ–∑–¥", "–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ", "—Ç—É—Ä–∏–∑–º", "–æ—Ç–µ–ª—å", "–≥–æ—Å—Ç–∏–Ω–∏—Ü–∞", "–ª–∞–≥–µ—Ä—å", "–ø–∞–ª–∞—Ç–∫–∞", "–∫–µ–º–ø–∏–Ω–≥", "–∞–ª—å–ø–∏–Ω–∏–∑–º", "—Å–∫–∞–ª–æ–ª–∞–∑–∞–Ω–∏–µ", "—Å–ø–ª–∞–≤", "–∫–∞—Ç–∞–Ω–∏–µ", "–ª—ã–∂–∏", "—Å–Ω–æ—É–±–æ—Ä–¥", "–∫–æ–Ω—å–∫–∏", "—Ö–æ–∫–∫–µ–π", "—Ñ—É—Ç–±–æ–ª", "–±–∞—Å–∫–µ—Ç–±–æ–ª", "–≤–æ–ª–µ–π–±–æ–ª", "—Ç–µ–Ω–Ω–∏—Å", "–±–µ–≥", "–º–∞—Ä–∞—Ñ–æ–Ω", "—Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ", "—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞", "—Å–ø–æ—Ä—Ç", "–∞—Ä–µ–Ω–∞", "—Å—Ç–∞–¥–∏–æ–Ω", "–ø–æ–ª–µ", "–ø–ª–æ—â–∞–¥–∫–∞", "–∞–ª–ª–µ—è", "—Å–∞–¥", "–æ–≥–æ—Ä–æ–¥", "–ª–µ—Å", "–≥–æ—Ä–∞", "–æ–∑–µ—Ä–æ", "—Ä–µ–∫–∞", "–≤–æ–¥–æ–ø–∞–¥", "–º–æ—Ä–µ", "–æ—Å—Ç—Ä–æ–≤", "–ø–µ—â–µ—Ä–∞", "–∫–∞–Ω—å–æ–Ω", "–≤–µ—Ä—à–∏–Ω–∞", "—Ç—Ä–æ–ø–∞", "–¥–æ—Ä–æ–≥–∞", "—à–æ—Å—Å–µ", "—É–ª–∏—Ü–∞", "–ø–µ—Ä–µ—É–ª–æ–∫", "–ø–ª–æ—â–∞–¥—å", "–±—É–ª—å–≤–∞—Ä", "–Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è", "–±–µ—Ä–µ–≥", "–º—ã—Å", "–∑–∞–ª–∏–≤", "–±—É—Ö—Ç–∞", "—Å–∫–∞–ª–∞", "—É—â–µ–ª—å–µ", "—Ñ–æ–Ω—Ç–∞–Ω", "—Å–∫–≤–µ—Ä", "—Ä–æ—Å–∞", "–≥—Ä–æ–∑–∞", "–¥–æ–∂–¥—å", "—Å–Ω–µ–≥", "–≤–µ—Ç–µ—Ä", "—Å–æ–ª–Ω—Ü–µ", "–ª—É–∂–∞", "–≥—Ä—è–¥–∫–∞", "—Ç–µ–ø–ª–∏—Ü–∞", "—Ä–∞—Å—Å–∞–¥–∞", "—Å–∞–∂–µ–Ω–µ—Ü", "–ø–æ—Å–∞–¥–∫–∞", "–ø–æ–ª–∏–≤", "–ø—Ä–æ–ø–æ–ª–∫–∞", "—É–±–æ—Ä–∫–∞", "—Å–±–æ—Ä", "—É—Ä–æ–∂–∞–π", "–∫–æ–º–ø–æ—Å—Ç", "–º—É—Å–æ—Ä", "–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞", "–ª–∞–Ω–¥—à–∞—Ñ—Ç", "–æ–∑–µ–ª–µ–Ω–µ–Ω–∏–µ", "–±–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ", "–±–ª–∞–≥–æ—É—Å—Ç—Ä–æ–∏—Ç—å", "–ø–æ—Å–∞–¥–∏—Ç—å", "–≤—ã—Å–∞–¥–∏—Ç—å", "–≤—ã–≥—É–ª—è—Ç—å", "–ø–æ–≥—É–ª—è—Ç—å", "—Å—Ö–æ–¥–∏—Ç—å", "–ø–æ–µ—Ö–∞—Ç—å", "–æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è", "–≤—ã–µ—Ö–∞—Ç—å", "–ø—Ä–∏–µ—Ö–∞—Ç—å", "–ø–æ—Å–µ—Ç–∏—Ç—å", "–æ–±–æ–π—Ç–∏", "–æ—Å–º–æ—Ç—Ä–µ—Ç—å", "–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å", "–Ω–∞–±–ª—é–¥–∞—Ç—å", "—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å", "—Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å", "—Ä–∏—Å–æ–≤–∞—Ç—å", "–ø–∏—Å–∞—Ç—å", "–ª–µ–ø–∏—Ç—å", "—Ç–∞–Ω—Ü–µ–≤–∞—Ç—å", "–ø–µ—Ç—å", "–∏–≥—Ä–∞—Ç—å", "–≥—É–ª—è—Ç—å"}
    indoor_words = {"–æ—Ñ–∏—Å", "–¥–æ–º", "–∫–≤–∞—Ä—Ç–∏—Ä–∞", "–¥–æ–º–∞—à–Ω–∏–π", "–¥–æ–º–∏–∫", "–∫–æ–º–Ω–∞—Ç–∞", "–∫—É—Ö–Ω—è", "–≤–∞–Ω–Ω–∞—è", "–≤–∞–Ω–Ω–∞", "—Ç—É–∞–ª–µ—Ç", "—Å–∞–Ω—É–∑–µ–ª", "–≥–æ—Å—Ç–∏–Ω–∞—è", "–ø–æ–¥–≤–∞–ª", "–±–∞–ª–∫–æ–Ω", "–ª–æ–¥–∂–∏—è", "–∫–æ—Ä–∏–¥–æ—Ä", "–ø—Ä–∏—Ö–æ–∂–∞—è", "—Å—Ç–æ–ª–æ–≤–∞—è", "—Å–ø–∞–ª—å–Ω—è", "–≥–∞—Ä–¥–µ—Ä–æ–±", "–∫–ª–∞–¥–æ–≤–∫–∞", "–º–∞—Å—Ç–µ—Ä—Å–∫–∞—è", "–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è", "–∫–ª–∏–Ω–∏–∫–∞", "–±–æ–ª—å–Ω–∏—Ü–∞", "–ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞", "–∞–ø—Ç–µ–∫–∞", "—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç", "–≤—É–∑–∞", "—à–∫–æ–ª–∞", "—Å–∞–¥–∏–∫", "–¥–µ—Ç—Å–∫–∏–π", "–∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä", "–∫–∏–Ω–æ", "–º—É–∑–µ–π", "–≥–∞–ª–µ—Ä–µ—è", "–±–∏–±–ª–∏–æ—Ç–µ–∫–∞", "—Ç–µ–∞—Ç—Ä", "–∫–æ–Ω—Ü–µ—Ä—Ç", "–∫–∞—Ñ–µ", "—Ä–µ—Å—Ç–æ—Ä–∞–Ω", "–±–∞—Ä", "–∞–Ω—Ç–∏–∫–∞—Ñ–µ", "–∞—Ç–µ–ª—å–µ", "–ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä—Å–∫–∞—è", "—Å–∞–ª–æ–Ω", "–æ—Ñ–∏—Å–Ω—ã–π", "–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü-–∑–∞–ª", "–∞—É–¥–∏—Ç–æ—Ä–∏—è", "–ª–µ–∫—Ü–∏—è", "—Å–µ–º–∏–Ω–∞—Ä", "–∑–∞–Ω—è—Ç–∏–µ", "—É—Ä–æ–∫", "–≤–µ–±–∏–Ω–∞—Ä", "–æ–Ω–ª–∞–π–Ω", "–≤–∏–¥–µ–æ–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è", "–∑–≤–æ–Ω–æ–∫", "—Å–æ–∑–≤–æ–Ω", "—Å–æ–≤–µ—â–∞–Ω–∏–µ", "–≤—Å—Ç—Ä–µ—á–∞", "–ø–ª–∞–Ω—ë—Ä–∫–∞", "–±—Ä–∏—Ñ–∏–Ω–≥", "–∏–Ω—Ç–µ—Ä–≤—å—é", "—Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ", "—Ä–µ–ø–µ—Ç–∏—Ü–∏—è", "—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä", "—Ç—Ä–µ–Ω–∞–∂—ë—Ä–Ω—ã–π", "—Å–ø–æ—Ä—Ç–∑–∞–ª", "—Ñ–∏—Ç–Ω–µ—Å", "–±–∞—Å—Å–µ–π–Ω", "—Å–∞—É–Ω–∞", "–±–∞–Ω—è", "—Å–∞—Ä–∞–π", "–≥–∞—Ä–∞–∂", "–∞–≤—Ç–æ–º–æ–π–∫–∞", "–∞–≤—Ç–æ—Å–∞–ª–æ–Ω", "–∞–≤—Ç–æ—à–∫–æ–ª–∞", "–≥–æ—Å—Ç–∏–Ω–∏—Ü–∞", "–æ—Ç–µ–ª—å", "—Ö–æ—Å—Ç–µ–ª", "–æ–±—â–µ–∂–∏—Ç–∏–µ", "–ø–µ–Ω—Å–∏–æ–Ω–∞—Ç", "—Å–∞–Ω–∞—Ç–æ—Ä–∏–π", "–ª–∞–≥–µ—Ä—å", "–ø–∞–ª–∞—Ç–∫–∞", "–¥–∞—á–∞", "–±–µ—Å–µ–¥–∫–∞", "–º–∞–≥–∞–∑–∏–Ω", "—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç", "—Ä—ã–Ω–æ–∫", "—è—Ä–º–∞—Ä–∫–∞", "–≤—ã—Å—Ç–∞–≤–∫–∞", "–ø–∞–≤–∏–ª—å–æ–Ω", "–≥–∞–ª–µ—Ä–µ—è", "—Å—Ç—É–¥–∏—è", "—Ü–µ—Ö", "–∑–∞–≤–æ–¥", "—Ñ–∞–±—Ä–∏–∫–∞", "—Å–∫–ª–∞–¥", "–æ—Ñ–∏—Å–Ω–æ–µ", "—Ä–∞–±–æ—á–∏–π", "—Å–ª—É–∂–µ–±–Ω—ã–π", "–ª–µ—á–µ–±–Ω—ã–π", "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π", "—Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è", "—Ö–∏—Ä—É—Ä–≥–∏—è", "—Ä–µ–Ω—Ç–≥–µ–Ω", "–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–π", "—É—á–µ–±–Ω—ã–π", "–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π", "—Ç–≤–æ—Ä—á–µ—Å–∫–∏–π", "–∫—É–ª–∏–Ω–∞—Ä–Ω—ã–π", "–º–∞—Å—Ç–µ—Ä–∫–ª–∞—Å—Å", "–∫—É—Ä—Å", "—Ç—Ä–µ–Ω–∏–Ω–≥", "–ª–µ–∫—Ç–æ—Ä–∏–π", "–ª–µ–∫—Ç–æ—Ä–∏–π", "–∫–∞–±–∏–Ω–µ—Ç", "–∫–∞–±–∏–Ω–µ—Ç–Ω—ã–π", "–∏–Ω—Å—Ç–∏—Ç—É—Ç", "–∞–∫–∞–¥–µ–º–∏—è", "–∫–æ–ª–ª–µ–¥–∂", "–ª–∏—Ü–µ–π", "–≥–∏–º–Ω–∞–∑–∏—è", "–∏–Ω—Ç–µ—Ä–Ω–∞—Ç", "—Ü–µ—Ä–∫–æ–≤—å", "—Ö—Ä–∞–º", "–º–µ—á–µ—Ç—å", "—Å–∏–Ω–∞–≥–æ–≥–∞", "–∫–∞–ø–µ–ª–ª–∞", "–¥–∏—Å–ø–∞–Ω—Å–µ—Ä", "—Ä–æ–¥–¥–æ–º", "–∫–ª–∏–Ω–∏–∫–∞", "–∞–ø—Ç–µ–∫–∞", "–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è", "–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π", "–ø–∞–ª–∞—Ç–∞", "—Ä–µ–∞–Ω–∏–º–∞—Ü–∏—è", "–ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–π", "—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞", "—Ñ–µ–ª—å–¥—à–µ—Ä", "–º–µ–¥—Å–µ—Å—Ç—Ä–∞", "–≤—Ä–∞—á", "—Ç–µ—Ä–∞–ø–µ–≤—Ç", "—Ö–∏—Ä—É—Ä–≥", "–≥–∏–Ω–µ–∫–æ–ª–æ–≥", "–æ—Ñ—Ç–∞–ª—å–º–æ–ª–æ–≥", "–ø—Å–∏—Ö–∏–∞—Ç—Ä", "–ø—Å–∏—Ö–æ–ª–æ–≥", "–ª–æ–≥–æ–ø–µ–¥", "–Ω–µ–≤—Ä–æ–ª–æ–≥", "–∫–∞—Ä–¥–∏–æ–ª–æ–≥", "–æ—Ä—Ç–æ–ø–µ–¥", "—Ç—Ä–∞–≤–º–∞—Ç–æ–ª–æ–≥", "—É—Ä–æ–ª–æ–≥", "—ç–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥", "–≥–∞—Å—Ç—Ä–æ—ç–Ω—Ç–µ—Ä–æ–ª–æ–≥", "–ø—É–ª—å–º–æ–Ω–æ–ª–æ–≥", "–¥–µ—Ä–º–∞—Ç–æ–ª–æ–≥", "–∞–ª–ª–µ—Ä–≥–æ–ª–æ–≥", "–æ–Ω–∫–æ–ª–æ–≥", "—Ä–∞–¥–∏–æ–ª–æ–≥", "–∞–Ω–µ—Å—Ç–µ–∑–∏–æ–ª–æ–≥", "—Ä–µ–∞–Ω–∏–º–∞—Ç–æ–ª–æ–≥", "–Ω–µ–æ–Ω–∞—Ç–æ–ª–æ–≥", "–ø–µ–¥–∏–∞—Ç—Ä", "–≥–µ—Ä–æ–Ω—Ç–æ–ª–æ–≥", "–Ω–∞—Ä–∫–æ–ª–æ–≥", "—Ç–æ–∫—Å–∏–∫–æ–ª–æ–≥", "—ç–ø–∏–¥–µ–º–∏–æ–ª–æ–≥", "–º–∏–∫—Ä–æ–±–∏–æ–ª–æ–≥", "—Ü–∏—Ç–æ–ª–æ–≥", "–≥–∏—Å—Ç–æ–ª–æ–≥", "–ø–∞—Ç–æ–º–æ—Ä—Ñ–æ–ª–æ–≥", "–≥–µ–Ω–µ—Ç–∏–∫", "–∏–º–º—É–Ω–æ–ª–æ–≥", "–≥–µ–º–∞—Ç–æ–ª–æ–≥", "–Ω–µ—Ñ—Ä–æ–ª–æ–≥", "–≥–µ–ø–∞—Ç–æ–ª–æ–≥", "—Ñ—Ç–∏–∑–∏–∞—Ç—Ä", "–≤–µ–Ω–µ—Ä–æ–ª–æ–≥", "—Å–µ–∫—Å–æ–ª–æ–≥", "—É—Ä–æ–ª–æ–≥", "–∞–Ω–¥—Ä–æ–ª–æ–≥", "–º–∞–º–º–æ–ª–æ–≥", "–∞–∫—É—à–µ—Ä", "–Ω–µ–æ–Ω–∞—Ç–æ–ª–æ–≥", "—Ä–µ–∞–±–∏–ª–∏—Ç–æ–ª–æ–≥", "—Ñ–∏–∑–∏–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç", "–º–∞–Ω—É–∞–ª—å–Ω—ã–π", "–æ—Å—Ç–µ–æ–ø–∞—Ç", "–∏–≥–ª–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç", "–≥–æ–º–µ–æ–ø–∞—Ç", "—Ñ–∏—Ç–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç", "–¥–∏–µ—Ç–æ–ª–æ–≥", "–Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥", "—Å–æ–º–Ω–æ–ª–æ–≥", "–∫–∞—Ä–¥–∏–æ—Ö–∏—Ä—É—Ä–≥", "–Ω–µ–π—Ä–æ—Ö–∏—Ä—É—Ä–≥", "–ø–ª–∞—Å—Ç–∏—á–µ—Å–∫–∏–π", "—Ç—Ä–∞–≤–º–∞—Ç–æ–ª–æ–≥-–æ—Ä—Ç–æ–ø–µ–¥", "—á–µ–ª—é—Å—Ç–Ω–æ-–ª–∏—Ü–µ–≤–æ–π", "–æ—Ñ—Ç–∞–ª—å–º–æ—Ö–∏—Ä—É—Ä–≥", "—É—Ä–æ—Ö–∏—Ä—É—Ä–≥", "—Ç–æ—Ä–∞–∫–∞–ª—å–Ω—ã–π", "–∞–±–¥–æ–º–∏–Ω–∞–ª—å–Ω—ã–π", "—Å–æ—Å—É–¥–∏—Å—Ç—ã–π", "—ç–Ω–¥–æ–≤–∞—Å–∫—É–ª—è—Ä–Ω—ã–π", "—Ç—Ä–∞–Ω—Å–ø–ª–∞–Ω—Ç–æ–ª–æ–≥", "–æ–Ω–∫–æ—Ö–∏—Ä—É—Ä–≥", "–Ω–µ–π—Ä–æ–æ–Ω–∫–æ–ª–æ–≥", "–≥–µ—Ä–æ–Ω—Ç–æ–ª–æ–≥", "–ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç", "–∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π", "—Å—É–¥–µ–±–Ω—ã–π", "—Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π", "–º–∞—Å—Å–∞–∂–∏—Å—Ç", "–∫–æ—Å–º–µ—Ç–æ–ª–æ–≥", "–¥–µ—Ä–º–∞—Ç–æ–∫–æ—Å–º–µ—Ç–æ–ª–æ–≥", "—Ç—Ä–∏—Ö–æ–ª–æ–≥", "–ø–æ–¥–æ–ª–æ–≥", "—Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥", "–æ—Ä—Ç–æ–¥–æ–Ω—Ç", "–ø–∞—Ä–æ–¥–æ–Ω—Ç–æ–ª–æ–≥", "—Ö–∏—Ä—É—Ä–≥-—Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥", "–∏–º–ø–ª–∞–Ω—Ç–æ–ª–æ–≥", "–ø—Ä–æ—Ç–µ–∑–∏—Å—Ç", "–≥–∏–≥–∏–µ–Ω–∏—Å—Ç", "—Ä–µ–Ω—Ç–≥–µ–Ω–æ–ª–æ–≥", "—Ç–æ–º–æ–≥—Ä–∞—Ñ", "–£–ó–ò", "—ç—Ö–æ–∫–∞—Ä–¥–∏–æ–≥—Ä–∞—Ñ", "—ç–ª–µ–∫—Ç—Ä–æ–∫–∞—Ä–¥–∏–æ–≥—Ä–∞—Ñ", "—Å–ø–∏—Ä–æ–≥—Ä–∞—Ñ", "—ç–ª–µ–∫—Ç—Ä–æ—ç–Ω—Ü–µ—Ñ–∞–ª–æ–≥—Ä–∞—Ñ", "–ø–æ–ª–∏—Å–æ–º–Ω–æ–≥—Ä–∞—Ñ", "–ª–∞–±–æ—Ä–∞–Ω—Ç", "—Å–∞–Ω–∏—Ç–∞—Ä", "–≤–æ–¥–∏—Ç–µ–ª—å", "—Ñ–µ–ª—å–¥—à–µ—Ä", "–¥–µ–∂—É—Ä–Ω—ã–π", "–¥–µ–∂—É—Ä–∫–∞", "–¥–µ–∂—É—Ä—Å—Ç–≤–æ", "–¥–µ–∂—É—Ä–Ω—ã–π", "–¥–µ–∂—É—Ä–∫–∞", "–¥–µ–∂—É—Ä—Å—Ç–≤–æ", "–¥–µ–∂—É—Ä–Ω—ã–π", "–¥–µ–∂—É—Ä–∫–∞", "–¥–µ–∂—É—Ä—Å—Ç–≤–æ"}

    def transform_to_base_form(self, row: str) -> str:
        row = row.lower().translate(self.translator)
        words = row.split()
        mean_words = [word for word in words if not word in self.russian_stopwords]
        formed_words = [self.morph.parse(word)[0].normal_form for word in mean_words]

        return " ".join(formed_words)

    def is_outside(self, text: str) -> bool:
        t = self.transform_to_base_form(text).split()
        if any(word in self.outdoor_words for word in t):
            return True
        if any(word in self.indoor_words for word in t):
            return False
        return False

    def predict_classes(self, text: str):
        emb = self.get_embedding(text)
        emb_tensor = torch.tensor(emb, dtype=torch.float32).unsqueeze(0).to(DEVICE)

        with torch.no_grad():
            logits = mlp_model(emb_tensor)  # shape: [1, n_classes]
            probs = torch.sigmoid(logits).cpu().numpy().flatten()

        rel_prob = binary_clf.predict_proba([self.transform_to_base_form(text)])[0][1]
        probs[RELATIONS_IDX] = rel_prob

        thld_arr = np.array([thresholds[cls] for cls in mlb.classes_])
        pred_binary = (probs >= thld_arr).astype(int)
        labels = mlb.inverse_transform(pred_binary.reshape(1, -1))[0]

        return list(labels)

    @staticmethod
    def get_embedding(text: str) -> np.ndarray:
        inputs = tokenizer(
            text,
            truncation=True,
            padding=True,
            max_length=128,
            return_tensors="pt"
        ).to(DEVICE)
        with torch.no_grad():
            outputs = rubert_model(**inputs)
        return outputs.last_hidden_state[0, 0].cpu().numpy()

predictor = LabelPredictor()

def process_message(channel, method, properties, body):
    try:
        # 1. –ü–∞—Ä—Å–∏–Ω–≥ –≤—Ö–æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        request_data = json.loads(body.decode())
        user_input = request_data["userInput"]

        # 2. –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
        categories = predictor.predict_classes(user_input)
        on_the_street = predictor.is_outside(user_input)

        # 3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
        response = {
            "categories": categories,
            "onTheStreet": on_the_street
        }

        # 4. –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ–±—Ä–∞—Ç–Ω–æ
        channel.basic_publish(
            exchange="",
            routing_key=properties.reply_to,  # –æ—á–µ—Ä–µ–¥—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
            properties=pika.BasicProperties(
                correlation_id=properties.correlation_id
            ),
            body=json.dumps(response, ensure_ascii=False)
        )

        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        channel.basic_ack(delivery_tag=method.delivery_tag)

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {e}")
        print(traceback.format_exc())
        channel.basic_nack(delivery_tag=method.delivery_tag, requeue=False)

def start_rabbitmq_listener():
    try:
        time.sleep(10)

        connection = pika.BlockingConnection(
            pika.ConnectionParameters(
                host="rmq",
                port=5672
            )
        )
        channel = connection.channel()

        channel.exchange_declare(exchange="tempus", exchange_type="topic", durable=True)

        result = channel.queue_declare(queue="ml-classification")
        queue_name = result.method.queue

        channel.queue_bind(
            exchange="tempus",
            queue=queue_name,
            routing_key="ml.calculate-categories.command"
        )

        channel.basic_consume(
            queue=queue_name,
            on_message_callback=process_message,
            auto_ack=False
        )

        channel.start_consuming()

    except Exception as e:
        print(f"‚ùå RabbitMQ listener failed: {e}")
        raise


if __name__ == "__main__":
    rabbit_thread = Thread(target=start_rabbitmq_listener, daemon=True)
    rabbit_thread.start()

    print("üöÄ ML Category Service is running. Press Ctrl+C to exit.")

    try:
        while True:
            time.sleep(1)  # —á—Ç–æ–±—ã –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—Ç—å CPU
    except KeyboardInterrupt:
        print("\nüõë Shutting down...")